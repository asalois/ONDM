function [y1,xf1,xf2] = myNeuralNetworkFunctionMatrixNiose(x1,x2,xi1,xi2)
%MYNEURALNETWORKFUNCTION neural network simulation function.
%
% Auto-generated by MATLAB, 22-Oct-2020 15:31:56.
%
% [y1,xf1,xf2] = myNeuralNetworkFunction(x1,x2,xi1,xi2) takes these arguments:
%   x1 = 1xTS matrix, input #1
%   x2 = 1xTS matrix, input #2
%   xi1 = 1x5 matrix, initial 5 delay states for input #1.
%   xi2 = 1x5 matrix, initial 5 delay states for input #2.
% and returns:
%   y1 = 1xTS matrix, output #1
%   xf1 = 1x5 matrix, final 5 delay states for input #1.
%   xf2 = 1x5 matrix, final 5 delay states for input #2.
% where TS is the number of timesteps.

% ===== NEURAL NETWORK CONSTANTS =====

% Input 1
x1_step1.xoffset = -0.342966188436554;
x1_step1.gain = 0.905193269719982;
x1_step1.ymin = -1;

% Input 2
x2_step1.xoffset = 0;
x2_step1.gain = 2;
x2_step1.ymin = -1;

% Layer 1
b1 = [-1.7805166879964888782;-1.5837031842114099867;-1.408063002856096313;1.3417405946616172141;-1.1011636478075195189;-0.95159766839801074312;-0.96048560374479818869;0.22446995853666779075;0.109838298820842728;0.21353921515703089273;0.4776722391953573954;-0.088073192315853893186;-0.88953201701089734676;-1.0473112734422125314;1.6285814022347429031;1.5188082538352762896;1.9611126923640462838;1.6370618052180967439];
IW1_1 = [0.7319956079504377211 0.62968288198539268397 -0.33019101349600454842 0.081351536233331439574 0.65093146015419889316;0.59738226156288920521 -0.40284178931585340466 0.6429167060549516588 -0.64941592842188333723 0.37154035120048095608;-0.037239061921458427307 -1.3561780764940143396 0.41169646014682825808 0.088588143656196799425 -0.8624482902662643502;-0.39430882822243906727 0.38920942327428653673 0.15081824360272885754 0.70194435553614864531 -0.86137083735576780441;0.24013903315411638806 -1.0876052922617360785 -0.38558046417256491845 -0.39756448343861433559 0.093820840172401817614;-0.18334120998456793217 0.5581397715586894348 0.45428523616500987581 0.018597600022202176451 0.91528564444494975305;0.71376846670370464043 -0.46282806001358400838 0.6637667911495855888 0.75448225880642472152 -0.62830504852781443592;-3.9895035620507877105 -1.020311106182580474 0.34956675021042338258 -0.15379671345033377183 -0.30424812082891106169;-0.98687086836119164435 -1.5105474775357630168 -0.68839345655387595979 -0.25426371132459635316 0.64770932594099939195;0.11406168353791223957 -0.6401157558662448066 -0.64333188907559890612 -1.0250572241004152207 -0.2148751486155367485;-8.1414946856218701754 -5.1384366481862544518 -0.021739006875370395916 -0.20332701382089848896 0.04106170566156346069;-0.50317726769197290704 0.9414038905225036169 -0.21928815327140444014 0.25738226965837579518 0.71477838116205105745;-0.42980416067915633294 -0.17523773818145482739 -0.05278790951201817877 -0.0081827762485332106168 -0.21631701791916768673;-1.651709256840639739 -0.11950539011123721689 0.22865019951615181415 0.67982967508882208296 -1.0427369882561008385;0.38047255337100022166 0.20842988810771151398 0.94471811517071180297 0.15612602286413562735 0.37343483222704948465;0.4117394324804629635 0.64648940858247594399 -0.79087647154031237573 -0.085848820847449686111 0.081035945842011056217;-0.47190111071384527319 -0.23368306012185349751 -0.81284261562455373262 -0.58911516888300663464 0.39383358743006657843;0.47813001509083574714 -0.61521885451436020276 -0.46453770347207856695 -0.39545411759394172302 0.95576158565453572802];
IW1_2 = [-0.50132898381673607346 -0.5231938386952635911 -0.3687114847312926158 -0.88142921608682711643 0.11228900470701629055;-0.41025819249779182929 -0.5995657083787766517 0.77046527507957562886 -1.1808799984556712648 -0.041881530609537226395;-0.040236540837981386864 0.42779691813774928244 0.81892838021568548079 -0.16844711361296707541 -0.64351363796127103445;0.061332968869519416399 -0.72338885745625192136 -0.52647702905536730711 0.4006839418719150836 -1.1866508774745145871;-0.40919536448251525584 0.9746069801348153927 -0.74317882800008983057 -0.45240335908684981003 -0.52162219300668999367;0.97396915330886513207 0.020247939365325137717 0.87473119698178614101 -0.92221119530651973761 0.41075144101153121534;0.14595812564024185365 -0.32510121320429413716 0.74374167048421968573 -0.28217437866552907977 0.9299545813469912714;1.8896690897262025111 0.91058618971099003492 0.017610235709179297009 0.084711314770102505434 0.30429435247734276659;0.69459993528754970793 0.88452452225808986253 0.14288042604407774627 0.13185608807548351851 -0.28887908083497909617;0.056810593287283453479 0.58357504037991259072 0.85688122304228864223 0.42264241631560200974 0.91800981888336463665;4.1343418571777572623 3.0917968751218491974 0.84172294246146994734 0.32505956688455234227 0.030404106013305461087;0.32306766081728016671 -0.45802847337450230958 -0.3496860185536689869 0.90606556875519717043 -0.9856470194634893156;0.54052685258039956384 0.52030525774272418094 0.52055031476687663172 0.88998909946142956695 0.82027957489952119108;0.27261969057507784431 -0.34850865918992446346 -0.63476082181855564279 -0.14131223512567545053 0.47640259378060434425;-0.47391293235387349503 0.66315629728103242524 -0.80616941972700628671 0.69449309809905501734 0.24877100709672972378;-0.62090872759970283656 0.52376151698045214644 0.16223782985435866721 0.73544204028158499664 0.52952754061433793265;0.62814198707677726397 -0.53288474221123804941 -0.33279213752800707038 -0.22605397603930310613 -0.32466446116147473777;-0.13311968036736146481 0.98472978514204589917 0.58633434433541420372 0.81437332255466265973 0.40149720458091570086];

% Layer 2
b2 = 0.084111806102735608981;
LW2_1 = [-0.017160265452034369205 0.048817151550688615835 0.069016643446835376774 0.0094090542416609326132 0.00083910730984826983198 -0.029042916035440326239 0.086611504959613963561 0.18304316786536570238 0.18934879979733046373 0.11943347266212388236 -1.1999532520498867871 0.082671263719569731965 -0.080046259058612442838 0.00044410849591040033393 0.078887458119357295461 0.034333590925806130312 -0.060625158096461947976 -0.12316956359292682843];

% Output 1
y1_step1.ymin = -1;
y1_step1.gain = 2;
y1_step1.xoffset = 0;

% ===== SIMULATION ========

% Dimensions
TS = size(x1,2); % timesteps

% Input 1 Delay States
xd1 = mapminmax_apply(xi1,x1_step1);
xd1 = [xd1 zeros(1,1)];

% Input 2 Delay States
xd2 = mapminmax_apply(xi2,x2_step1);
xd2 = [xd2 zeros(1,1)];

% Allocate Outputs
y1 = zeros(1,TS);

% Time loop
for ts=1:TS
    
    % Rotating delay state position
    xdts = mod(ts+4,6)+1;
    
    % Input 1
    xd1(:,xdts) = mapminmax_apply(x1(:,ts),x1_step1);
    
    % Input 2
    xd2(:,xdts) = mapminmax_apply(x2(:,ts),x2_step1);
    
    % Layer 1
    tapdelay1 = reshape(xd1(:,mod(xdts-[1 2 3 4 5]-1,6)+1),5,1);
    tapdelay2 = reshape(xd2(:,mod(xdts-[1 2 3 4 5]-1,6)+1),5,1);
    a1 = tansig_apply(b1 + IW1_1*tapdelay1 + IW1_2*tapdelay2);
    
    % Layer 2
    a2 = b2 + LW2_1*a1;
    
    % Output 1
    y1(:,ts) = mapminmax_reverse(a2,y1_step1);
end

% Final delay states
finalxts = TS+(1: 5);
xits = finalxts(finalxts<=5);
xts = finalxts(finalxts>5)-5;
xf1 = [xi1(:,xits) x1(:,xts)];
xf2 = [xi2(:,xits) x2(:,xts)];
end

% ===== MODULE FUNCTIONS ========

% Map Minimum and Maximum Input Processing Function
function y = mapminmax_apply(x,settings)
y = bsxfun(@minus,x,settings.xoffset);
y = bsxfun(@times,y,settings.gain);
y = bsxfun(@plus,y,settings.ymin);
end

% Sigmoid Symmetric Transfer Function
function a = tansig_apply(n,~)
a = 2 ./ (1 + exp(-2*n)) - 1;
end

% Map Minimum and Maximum Output Reverse-Processing Function
function x = mapminmax_reverse(y,settings)
x = bsxfun(@minus,y,settings.ymin);
x = bsxfun(@rdivide,x,settings.gain);
x = bsxfun(@plus,x,settings.xoffset);
end
